# Система управления процессами

Система для запуска Telegram-бота и WebApp одной командой.

## Быстрый старт

```bash
# Запустить все процессы
make run-all

# Показать статус
make status

# Просмотр логов
make logs

# Остановить все
make stop-all

# Перезапустить все
make restart-all
```

## Команды

### Makefile цели
- `make run-all` - запустить Telegram-бот и WebApp
- `make stop-all` - остановить все процессы
- `make restart-all` - перезапустить все процессы
- `make status` - показать статус процессов
- `make logs` - показать логи (последние 100 строк)

### Прямые команды Python
```bash
python tools/run_all.py start     # Запустить все
python tools/run_all.py stop      # Остановить все  
python tools/run_all.py restart   # Перезапустить все
python tools/run_all.py status    # Показать статус
python tools/run_all.py logs      # Показать логи
```

## Файлы

### Логи
- `logs/bot.log` - логи Telegram-бота
- `logs/webapp.log` - логи WebApp

### PID файлы
- `.runtime/bot.pid` - PID процесса бота
- `.runtime/webapp.pid` - PID процесса WebApp

## Автоматическое обнаружение

Система автоматически находит entrypoints:
1. **Сначала** проверяет Makefile на наличие целей `run-bot` и `run-web`
2. **Если не найдены** - сканирует код на наличие:
   - Bot entrypoint: файлы с импортами `aiogram`/`telebot` и `if __name__ == "__main__"`
   - WebApp entrypoint: файлы с импортами `Flask`/`FastAPI` и `if __name__ == "__main__"`

## Особенности

### Защита от коллизий портов
- Автоматически проверяет доступность порта WebApp
- Предупреждает если порт занят
- Не прерывает запуск (возможно, это старый процесс)

### Graceful shutdown
- Сначала отправляет SIGTERM (мягкое завершение)
- Если процесс не завершился за 5 секунд - SIGKILL (принудительное)
- Поддерживает Windows и Unix-системы

### Поддержка .env
- Автоматически загружает `.env` файл если доступен `python-dotenv`
- Не требует дополнительных зависимостей

### Кроссплатформенность
- Работает на Windows, macOS, Linux
- Автоматически определяет команду Python
- Использует правильные сигналы для каждой ОС

## Безопасность

- **НЕ изменяет** бизнес-логику бота и WebApp
- **НЕ удаляет** существующие Makefile цели
- **Переиспользует** существующие команды запуска
- **Не завершает** чужие процессы без подтверждения

## Отладка

Если что-то не работает:

1. Проверьте статус: `make status`
2. Посмотрите логи: `make logs`
3. Убедитесь, что порты свободны
4. Проверьте, что entrypoints найдены корректно

## Примеры использования

```bash
# Разработка - запуск всех сервисов
make run-all

# Просмотр логов в реальном времени
tail -f logs/bot.log logs/webapp.log

# Проверка что все работает
make status

# Перезапуск после изменений
make restart-all

# Остановка перед деплоем
make stop-all
```
