<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WebApp Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #080; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üîß WebApp Debug Tool</h1>
    
    <div class="debug">
        <h3>User ID Detection</h3>
        <p>Current User ID: <strong id="userId">Loading...</strong></p>
        <p>Telegram WebApp Available: <strong id="telegramStatus">Checking...</strong></p>
    </div>
    
    <div class="debug">
        <h3>API Tests</h3>
        <button onclick="testNotifications()">üì¨ Test Notifications API</button>
        <button onclick="testSubscriptions()">üìã Test Subscriptions API</button>
        <button onclick="testNotificationSettings()">‚öôÔ∏è Test Notification Settings API</button>
        <div id="apiResults"></div>
    </div>
    
    <div class="debug">
        <h3>Console Logs</h3>
        <div id="consoleLogs"></div>
    </div>

    <script>
        // Override console.log to capture logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addLog(type, message) {
            const logsDiv = document.getElementById('consoleLogs');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${type.toUpperCase()}] ${new Date().toLocaleTimeString()}: ${message}`;
            logsDiv.appendChild(logEntry);
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('success', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('error', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('error', args.join(' '));
        };

        // Copy the getUserIdFromTelegram function
        function getUserIdFromTelegram() {
            // Check if we're running inside Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
                try {
                    const initData = window.Telegram.WebApp.initDataUnsafe;
                    if (initData && initData.user && initData.user.id) {
                        console.log('üîó Telegram user detected:', initData.user);
                        return initData.user.id.toString();
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to get Telegram user data:', error);
                }
            }
            
            // Fallback for development/testing
            console.warn('‚ö†Ô∏è Not running in Telegram WebApp, using demo user');
            return 'demo-user-123';
        }

        // Initialize
        let currentUserId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Debug page loaded');
            
            // Test user ID detection
            currentUserId = getUserIdFromTelegram();
            document.getElementById('userId').textContent = currentUserId;
            
            // Check Telegram WebApp availability
            const telegramAvailable = !!(window.Telegram && window.Telegram.WebApp);
            document.getElementById('telegramStatus').textContent = telegramAvailable ? 'Yes' : 'No';
            
            if (telegramAvailable) {
                console.log('Telegram WebApp object:', window.Telegram.WebApp);
                console.log('Init data:', window.Telegram.WebApp.initDataUnsafe);
            }
        });

        async function testAPI(endpoint, label) {
            try {
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (data.status === 'success') {
                    console.log(`‚úÖ ${label}: Success`);
                    return data;
                } else {
                    console.warn(`‚ùå ${label}: Failed - ${data.message || 'Unknown error'}`);
                    return null;
                }
            } catch (error) {
                console.error(`üí• ${label}: Error - ${error.message}`);
                return null;
            }
        }

        async function testNotifications() {
            const data = await testAPI(`/api/notifications?user_id=${currentUserId}&limit=5`, 'Notifications');
            if (data) {
                const results = document.getElementById('apiResults');
                results.innerHTML = `<h4>Notifications (${data.data.total_count} total, ${data.data.unread_count} unread):</h4>`;
                data.data.notifications.forEach((notif, i) => {
                    results.innerHTML += `<p>${i+1}. ${notif.title} (${notif.category}) - ${notif.read ? 'Read' : 'Unread'}</p>`;
                });
            }
        }

        async function testSubscriptions() {
            const data = await testAPI(`/api/subscriptions?user_id=${currentUserId}`, 'Subscriptions');
            if (data) {
                const results = document.getElementById('apiResults');
                results.innerHTML = `<h4>Subscriptions:</h4>`;
                data.data.subscriptions.forEach((sub, i) => {
                    results.innerHTML += `<p>${i+1}. ${sub.title} - ${sub.enabled ? 'Enabled' : 'Disabled'}</p>`;
                });
            }
        }

        async function testNotificationSettings() {
            const data = await testAPI(`/api/notification-settings?user_id=${currentUserId}`, 'Notification Settings');
            if (data) {
                const results = document.getElementById('apiResults');
                results.innerHTML = `<h4>Notification Settings:</h4>`;
                data.data.categories.forEach((cat, i) => {
                    results.innerHTML += `<p>${i+1}. ${cat.title} - Enabled: ${cat.enabled}, Telegram: ${cat.via_telegram}, WebApp: ${cat.via_webapp}</p>`;
                });
            }
        }
    </script>
</body>
</html>
