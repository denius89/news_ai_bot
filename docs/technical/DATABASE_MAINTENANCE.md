# Обслуживание базы данных

## Обзор

Этот документ описывает процедуры обслуживания базы данных PulseAI для поддержания оптимальной производительности и целостности данных.

## Структура базы данных

### Основные таблицы:
- **news** - новости (1200+ записей)
- **events** - события (170+ записей) 
- **users** - пользователи (5 записей)
- **user_notifications** - уведомления (5 записей)
- **digests** - дайджесты (0 записей)

### Связи:
- `user_notifications.user_id` → `users.id`
- `digests.user_id` → `users.id`

## Команды обслуживания

### 1. Полное обслуживание (рекомендуется)
```bash
make db-maintenance
# или
python tools/database_maintenance.py
```

**Что делает:**
- Показывает предварительную статистику
- Проверяет целостность данных
- Удаляет старые записи
- Показывает финальную статистику
- Дает рекомендации

### 2. Очистка данных
```bash
make db-cleanup
# или
python tools/cleanup_database.py
```

**Что удаляет:**
- Новости старше 30 дней
- События старше 60 дней
- Прочитанные уведомления старше 7 дней
- Дубликаты по uid/event_id
- Пустые дайджесты

### 3. Оптимизация
```bash
make db-optimize
# или
python tools/optimize_database.py
```

**Что делает:**
- Создает недостающие индексы
- Анализирует статистику таблиц
- Проверяет целостность связей
- Дает рекомендации по оптимизации

### 4. Проверка структуры
```bash
make db-check
# или
python tools/check_all_columns.py
python tools/check_users_table.py
```

**Что показывает:**
- Структуру всех таблиц
- Количество записей
- Примеры данных

## Рекомендации по обслуживанию

### Еженедельно:
- Запускать `make db-maintenance`
- Проверять логи на ошибки

### Ежемесячно:
- Запускать `make db-optimize`
- Анализировать рост таблиц
- Проверять производительность

### По необходимости:
- При проблемах с производительностью
- После массовых операций
- Перед важными обновлениями

## Мониторинг

### Ключевые метрики:
- Количество записей в каждой таблице
- Наличие дубликатов
- Целостность связей
- Время выполнения запросов

### Пороги для действий:
- **news > 2000 записей** → рассмотреть архивирование
- **events > 500 записей** → очистить старые
- **user_notifications > 100 записей** → очистить прочитанные
- **Дубликаты > 0** → запустить очистку

## Решение проблем

### Медленные запросы:
1. Проверить индексы: `make db-optimize`
2. Очистить старые данные: `make db-cleanup`
3. Анализировать планы выполнения

### Ошибки целостности:
1. Запустить проверку: `make db-check`
2. Исправить связи вручную
3. Запустить обслуживание: `make db-maintenance`

### Большой размер БД:
1. Очистить старые данные: `make db-cleanup`
2. Рассмотреть архивирование
3. Оптимизировать индексы: `make db-optimize`

## Автоматизация

### Cron задачи (пример):
```bash
# Еженедельное обслуживание (воскресенье в 2:00)
0 2 * * 0 cd /path/to/project && make db-maintenance

# Ежемесячная оптимизация (1 число в 3:00)
0 3 1 * * cd /path/to/project && make db-optimize
```

### Мониторинг:
- Настроить алерты на рост таблиц
- Логировать результаты обслуживания
- Отслеживать время выполнения

## Безопасность

### Перед обслуживанием:
- Сделать бэкап критичных данных
- Проверить доступность БД
- Уведомить команду о плановых работах

### После обслуживания:
- Проверить работоспособность приложения
- Убедиться в целостности данных
- Задокументировать изменения

## Контакты

При проблемах с базой данных обращайтесь к команде разработки или создавайте issue в репозитории.
