# PulseAI Security Policy

## –û–±–∑–æ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

PulseAI —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram WebApp.

## –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è Telegram WebApp

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

1. **HMAC SHA256 –ø—Ä–æ–≤–µ—Ä–∫–∞**: –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram WebApp –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —á–µ—Ä–µ–∑ HMAC SHA256 –ø–æ–¥–ø–∏—Å—å
2. **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**: –î–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã –Ω–µ –±–æ–ª–µ–µ 24 —á–∞—Å–æ–≤
3. **Fallback —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –º–µ—Ç–æ–¥–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

### –ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏

```python
# 1. –ü–∞—Ä—Å–∏–Ω–≥ initData
parsed_data = dict(parse_qsl(init_data))

# 2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ hash
hash_value = parsed_data.pop('hash')

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
auth_date = int(parsed_data.get('auth_date', 0))
if current_time - auth_date > 86400:
    return None

# 4. –°–æ–∑–¥–∞–Ω–∏–µ data_check_string
data_check_arr = [f"{k}={v}" for k, v in sorted(parsed_data.items())]
data_check_string = '\n'.join(data_check_arr)

# 5. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ HMAC SHA256
secret_key = hashlib.sha256(bot_token.encode()).digest()
calculated_hash = hmac.new(secret_key, data_check_string.encode(), hashlib.sha256).hexdigest()

# 6. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
if not hmac.compare_digest(calculated_hash, hash_value):
    return None
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫

- **Timing attacks**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `hmac.compare_digest()` –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
- **Hash collisions**: HMAC SHA256 –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫—É—é —Å—Ç–æ–π–∫–æ—Å—Ç—å
- **Data tampering**: –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–≤–µ—Ä–Ω–æ–º—É hash

## –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **Emoji-only –∏–º–µ–Ω–∞**: `üî•üî•üî•` ‚Üí `User #<user_id>`
2. **–ù–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã**: `John\u200bDoe` ‚Üí `JohnDoe`
3. **–°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ Unicode**: `ùïÄùïßùïíùïü` ‚Üí `Ivan`
4. **–ò—Å–ø–æ—Ä—á–µ–Ω–Ω–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞**: `√ê√ê¬∞√ê¬Ω` ‚Üí `–ò–≤–∞–Ω`
5. **RTL —Ç–µ–∫—Å—Ç**: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
6. **–ö–∏—Ç–∞–π—Å–∫–∏–µ/—è–ø–æ–Ω—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã**: –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å

### –ê–ª–≥–æ—Ä–∏—Ç–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

```python
def normalize_user_name(raw_name, username, user_id):
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏–º–µ–Ω–∏
    if not raw_name or not raw_name.strip():
        return _get_fallback_name(username, user_id)
    
    # 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å–ø–æ—Ä—á–µ–Ω–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏
    processed_name = _fix_corrupted_encoding(raw_name)
    
    # 3. –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–∏–¥–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    cleaned_name = _remove_invisible_chars(processed_name)
    
    # 4. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö Unicode
    normalized_name = _convert_styled_unicode(cleaned_name)
    
    # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ emoji-only
    if _is_emoji_only(normalized_name):
        return _get_fallback_name(username, user_id)
    
    # 6. –û–±—Ä–µ–∑–∫–∞ –¥–æ 64 —Å–∏–º–≤–æ–ª–æ–≤
    final_name = _truncate_preserving_words(normalized_name, 64)
    
    return final_name.strip()
```

## –°–µ—Å—Å–∏–∏ –∏ –∫—É–∫–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```python
app.config.update(
    SECRET_KEY=os.getenv('FLASK_SECRET_KEY'),
    SESSION_COOKIE_HTTPONLY=True,      # –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
    SESSION_COOKIE_SECURE=True,        # –¢–æ–ª—å–∫–æ HTTPS
    SESSION_COOKIE_SAMESITE='Lax',     # –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF
    PERMANENT_SESSION_LIFETIME=timedelta(hours=24)
)
```

### Middleware –∑–∞—â–∏—Ç–∞

```python
@app.before_request
def validate_session():
    if request.path.startswith('/api/'):
        if 'user_id' not in session and request.endpoint != 'api.get_user_by_telegram_id':
            return jsonify({"status": "error", "message": "Unauthorized"}), 401
```

## CORS –ø–æ–ª–∏—Ç–∏–∫–∞

### –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã

```python
CORS(app, origins=[
    "https://*.trycloudflare.com",     # Cloudflare —Ç—É–Ω–Ω–µ–ª–∏
    "https://telegram.org",            # Telegram –¥–æ–º–µ–Ω—ã
    "https://web.telegram.org",
    "https://t.me"
])
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```python
def log_auth_attempt(telegram_id, success, method, error=None):
    if success:
        logger.info(f"Telegram auth success: user_id={telegram_id}, method={method}")
    else:
        logger.warning(f"Telegram auth failed: user_id={telegram_id}, method={method}, error={error}")
```

### –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π

- **–£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: `initData`, `userData`, `fallback`
- **–ù–µ—É–¥–∞—á–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: –ù–µ–≤–µ—Ä–Ω—ã–π hash, –∏—Å—Ç—ë–∫—à–∏–π auth_date, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
- **–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –ó–∞—â–∏—Ç–∞ –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Supabase ORM —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

- –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ
- Telegram user ID –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—é

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è production
TELEGRAM_BOT_TOKEN=your_bot_token
FLASK_SECRET_KEY=your_secret_key_32_chars_min
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_key

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
DEBUG=false
WEBAPP_HOST=127.0.0.1
```

### HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω

- –í—Å–µ production —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS
- `SESSION_COOKIE_SECURE=True` —Ç–æ–ª—å–∫–æ –¥–ª—è HTTPS
- Cloudflare —Ç—É–Ω–Ω–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç HTTPS

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

## –ú–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

1. **–§–∞–∑–∞ 1**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Ç–µ–∫—É—â–∞—è)
2. **–§–∞–∑–∞ 2**: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –º–µ—Ç–æ–¥–∞
3. **–§–∞–∑–∞ 3**: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ (—á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏)
4. **–§–∞–∑–∞ 4**: –£–¥–∞–ª–µ–Ω–∏–µ legacy –∫–æ–¥–∞

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –°—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

1. –ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–µ issue
2. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –∫–æ–º–∞–Ω–¥–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–ø—Ä—è–º—É—é
3. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
4. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è

## –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏

–≠—Ç–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ –º–µ—Ä–µ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–∏—Å—Ç–µ–º—ã. –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-01-06.

---

**–í–∞–∂–Ω–æ**: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - —ç—Ç–æ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å. –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –º–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–æ–≤—ã–º–∏ —É–≥—Ä–æ–∑–∞–º–∏.
