{% extends "base.html" %}

{% block content %}
<h1>ğŸ—“ï¸ Economic & Crypto Calendar</h1>

<!-- Ğ¡Ñ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ -->
<div id="today-counter" class="today-counter">
    âš¡ Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ: <span id="today-count">0</span> ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
</div>

<!-- Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ´Ğ»Ñ Ğ´ĞµÑĞºÑ‚Ğ¾Ğ¿Ğ° -->
<div class="events-table">
    <table>
        <thead>
            <tr>
                <th>â° Ğ’Ñ€ĞµĞ¼Ñ</th>
                <th>ğŸŒ Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ°</th>
                <th>ğŸ“Œ Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ</th>
                <th>â­ Ğ’Ğ°Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ</th>
                <th>ğŸ“Š</th>
                <th>ğŸ“ˆ</th>
                <th>ğŸ“‰</th>
            </tr>
        </thead>
        <tbody>
            {% for ev in events %}
            <tr class="event-row" data-time="{{ ev.event_time }}">
                <td>
                    <span class="event-time-main">{{ ev.event_time_fmt }}</span>
                    <span class="event-time-remaining time-remaining" data-time="{{ ev.event_time }}"></span>
                </td>
                <td>
                    {% if ev.country %}
                        <span class="fi fi-{{ ev.country|lower }}"></span>
                    {% endif %}
                    {{ ev.currency or "" }}
                </td>
                <td>{{ ev.title or "â€”" }}</td>
                <td>
                    {% if ev.importance == 1 %}
                        â­ <span class="importance-low">Low</span>
                    {% elif ev.importance == 2 %}
                        â­â­ <span class="importance-medium">Medium</span>
                    {% elif ev.importance == 3 %}
                        â­â­â­ <span class="importance-high">High</span>
                    {% else %}
                        â€”
                    {% endif %}
                </td>
                <td>{{ ev.fact or "â€”" }}</td>
                <td>{{ ev.forecast or "â€”" }}</td>
                <td>{{ ev.previous or "â€”" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸ -->
<div class="events-cards">
    {% for ev in events %}
    <div class="event-card" data-time="{{ ev.event_time }}">
        <span class="event-time-main">{{ ev.event_time_fmt }}</span>
        <span class="event-time-remaining time-remaining" data-time="{{ ev.event_time }}"></span>

        <div class="event-country">
            {% if ev.country %}
                <span class="fi fi-{{ ev.country|lower }}"></span>
            {% endif %}
            {{ ev.currency or "" }}
        </div>

        <div class="event-title">{{ ev.title or "â€”" }}</div>

        <div class="event-meta">
            {% if ev.importance == 1 %}
                â­ <span class="importance-low">Low</span>
            {% elif ev.importance == 2 %}
                â­â­ <span class="importance-medium">Medium</span>
            {% elif ev.importance == 3 %}
                â­â­â­ <span class="importance-high">High</span>
            {% else %}
                â€”
            {% endif %}
        </div>

        <div class="event-stats">
            <span>ğŸ“Š {{ ev.fact or "â€”" }}</span>
            <span>ğŸ“ˆ {{ ev.forecast or "â€”" }}</span>
            <span>ğŸ“‰ {{ ev.previous or "â€”" }}</span>
        </div>
    </div>
    {% endfor %}
</div>

<!-- JS Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ -->
<script>
function updateTimeRemaining() {
    const now = new Date();
    const todayStr = now.toISOString().slice(0, 10);
    let todayCount = 0;

    document.querySelectorAll(".time-remaining").forEach(el => {
        const targetTime = new Date(el.dataset.time);
        if (isNaN(targetTime)) return;

        const diffMs = targetTime - now;
        if (diffMs <= 0) {
            el.textContent = "â³ Ğ£Ğ¶Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾";
            return;
        }

        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffDays > 0) {
            el.textContent = `Ñ‡ĞµÑ€ĞµĞ· ${diffDays} Ğ´Ğ½. ${diffHours % 24} Ñ‡.`;
        } else if (diffHours > 0) {
            el.textContent = `Ñ‡ĞµÑ€ĞµĞ· ${diffHours} Ñ‡. ${diffMins % 60} Ğ¼Ğ¸Ğ½.`;
        } else {
            el.textContent = `Ñ‡ĞµÑ€ĞµĞ· ${diffMins} Ğ¼Ğ¸Ğ½.`;
        }
    });

    document.querySelectorAll(".event-row, .event-card").forEach(row => {
        const targetTime = new Date(row.dataset.time);
        if (!isNaN(targetTime)) {
            const targetStr = targetTime.toISOString().slice(0, 10);
            if (targetStr === todayStr) {
                row.classList.add("event-today");
                todayCount++;
            }
        }
    });

    document.getElementById("today-count").textContent = todayCount;
}

updateTimeRemaining();
setInterval(updateTimeRemaining, 60000);
</script>
{% endblock %}