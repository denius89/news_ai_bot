{% extends "base.html" %}

{% block content %}
<!-- –°—á—ë—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π —Å–µ–≥–æ–¥–Ω—è -->
<div id="today-counter" class="today-counter">
    ‚ö° –°–µ–≥–æ–¥–Ω—è: <span id="today-count">0</span> —Å–æ–±—ã—Ç–∏–π
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ -->
<div class="events-table">
    <table>
        <thead>
            <tr>
                <th>‚è∞ –í—Ä–µ–º—è</th>
                <th>üåç –°—Ç—Ä–∞–Ω–∞</th>
                <th>üìå –°–æ–±—ã—Ç–∏–µ</th>
                <th>‚≠ê –í–∞–∂–Ω–æ—Å—Ç—å</th>
                <th>üìä –§–∞–∫—Ç</th>
                <th>üìà –ü—Ä–æ–≥–Ω–æ–∑</th>
                <th>üìâ –ü—Ä–µ–¥—ã–¥—É—â–µ–µ</th>
            </tr>
        </thead>
        <tbody>
            {% for ev in events %}
            <tr class="event-row" data-time="{{ ev.event_time }}">
                <td>
                    <span class="event-time-main">{{ ev.event_time_fmt }}</span>
                    <span class="event-time-remaining time-remaining" data-time="{{ ev.event_time }}"></span>
                </td>
                <td>
                    {% if ev.country %}
                        <span class="fi fi-{{ ev.country_code|lower }}"></span>
                    {% endif %}
                    {{ ev.currency or "" }}
                </td>
                <td>
                    {{ ev.title or "‚Äî" }}
                    {% if ev.subcategory and ev.subcategory != 'general' %}
                        <br><small class="text-muted">{{ ev.category }} ‚Üí {{ ev.subcategory }}</small>
                    {% endif %}
                </td>
                <td>
                    {% if ev.importance == 1 %}
                        <span class="importance-low">‚≠ê Low</span>
                    {% elif ev.importance == 2 %}
                        <span class="importance-medium">‚≠ê‚≠ê Medium</span>
                    {% elif ev.importance == 3 %}
                        <span class="importance-high">‚≠ê‚≠ê‚≠ê High</span>
                    {% else %}
                        ‚Äî
                    {% endif %}

                    {% if ev.priority %}
                        <span class="badge
                          {% if ev.priority == 'high' %} bg-danger
                          {% elif ev.priority == 'medium' %} bg-warning text-dark
                          {% else %} bg-secondary
                          {% endif %}">
                          {{ ev.priority|capitalize }}
                        </span>
                    {% endif %}
                </td>
                <td>{{ ev.fact or "‚Äî" }}</td>
                <td>{{ ev.forecast or "‚Äî" }}</td>
                <td>{{ ev.previous or "‚Äî" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ -->
<div class="events-cards">
    {% for ev in events %}
    <div class="event-card" data-time="{{ ev.event_time }}">
        <div class="event-card-header">
            <span class="event-time-main">{{ ev.event_time_fmt }}</span>
            <span class="event-time-remaining time-remaining" data-time="{{ ev.event_time }}"></span>
        </div>

        <div class="event-country">
            {% if ev.country %}
                <span class="fi fi-{{ ev.country_code|lower }}"></span>
            {% endif %}
            {{ ev.currency or "" }}
        </div>

        <div class="event-title">{{ ev.title or "‚Äî" }}</div>
        {% if ev.subcategory and ev.subcategory != 'general' %}
            <div class="event-category">{{ ev.category }} ‚Üí {{ ev.subcategory }}</div>
        {% endif %}

        <div class="event-meta">
            {% if ev.importance == 1 %}
                <span class="importance-low">‚≠ê Low</span>
            {% elif ev.importance == 2 %}
                <span class="importance-medium">‚≠ê‚≠ê Medium</span>
            {% elif ev.importance == 3 %}
                <span class="importance-high">‚≠ê‚≠ê‚≠ê High</span>
            {% else %}
                ‚Äî
            {% endif %}

            {% if ev.priority %}
                <span class="badge
                  {% if ev.priority == 'high' %} bg-danger
                  {% elif ev.priority == 'medium' %} bg-warning text-dark
                  {% else %} bg-secondary
                  {% endif %}">
                  {{ ev.priority|capitalize }}
                </span>
            {% endif %}
        </div>

        <div class="event-stats">
            <span>üìä {{ ev.fact or "‚Äî" }}</span>
            <span>üìà {{ ev.forecast or "‚Äî" }}</span>
            <span>üìâ {{ ev.previous or "‚Äî" }}</span>
        </div>
    </div>
    {% endfor %}
</div>

<!-- JS –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ -->
<script>
function updateTimeRemaining() {
    const now = new Date();
    const todayStr = now.toISOString().slice(0, 10);
    let todayCount = 0;

    document.querySelectorAll(".time-remaining").forEach(el => {
        const targetTime = new Date(el.dataset.time);
        if (isNaN(targetTime)) return;

        const diffMs = targetTime - now;
        if (diffMs <= 0) {
            el.textContent = "‚è≥ –£–∂–µ –ø—Ä–æ—à–ª–æ";
            return;
        }

        const mins = Math.floor(diffMs / 60000);
        const hrs = Math.floor(mins / 60);
        const days = Math.floor(hrs / 24);

        if (days > 0) {
            el.textContent = `—á–µ—Ä–µ–∑ ${days} –¥–Ω. ${hrs % 24} —á.`;
        } else if (hrs > 0) {
            el.textContent = `—á–µ—Ä–µ–∑ ${hrs} —á. ${mins % 60} –º–∏–Ω.`;
        } else {
            el.textContent = `—á–µ—Ä–µ–∑ ${mins} –º–∏–Ω.`;
        }
    });

    document.querySelectorAll(".event-row, .event-card").forEach(row => {
        const targetTime = new Date(row.dataset.time);
        if (!isNaN(targetTime)) {
            if (targetTime.toISOString().slice(0, 10) === todayStr) {
                row.classList.add("event-today");
                todayCount++;
            }
        }
    });

    document.getElementById("today-count").textContent = todayCount;
}

updateTimeRemaining();
setInterval(updateTimeRemaining, 60000);
</script>
{% endblock %}